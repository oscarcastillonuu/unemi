{% extends "basebs.html" %}
{% load humanize %}
{% block heading %}
    <script type="text/javascript" src='/static/js/select2.js?v=1.0.0'></script>
    <script type="text/javascript">
        function calcularubrica(codigo) {
            {#bloqueointerface();#}
            numerico($("#id_cantidad" + codigo), 0, 100, 0)
            var cantidad = $("#id_cantidad" + codigo).val()
            if (cantidad < 1) {
                smoke.alert("Tiene que llenar con cantidad mayor a 0.");
                return false;
            }
            bloqueointerface();
            $.ajax({
                type: "POST",
                url: "/adm_periodos",
                data: {'action': 'updatecantidad', 'idcodigo': codigo, 'cantidad': cantidad},
                success: function (data) {
                    if (data.result == 'ok') {
                        $.unblockUI();
                    } else {
                        $.unblockUI();
                        smoke.alert(data.mensaje);
                    }
                },
                error: function () {
                    $.unblockUI();
                    smoke.alert("Error de conexión.");
                },
                dataType: "json"
            });
        }

        function eliminarajax2(pk, nombre, accion, url = '{{ request.path }}', titulo = 'Estás por eliminar los componentes del periodo:') {
            Swal.fire({
                html: `<b>${titulo}</b> ${nombre}`,
                text: "Esta acción es irreversible",
                type: 'warning',
                showCancelButton: true,
                allowOutsideClick: false,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Si, deseo hacerlo',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.value) {
                    bloqueointerface();
                    $.ajax({
                        type: 'POST',
                        url: '{{ reques.path }}',
                        async: false,
                        data: {
                            csrfmiddlewaretoken: '{{ csrf_token }}',
                            action: accion,
                            id: pk,
                        },
                        dataType: "json",
                        beforeSend: function () {
                            bloqueointerface();
                        }
                    }).done(function (data) {
                        if (data.result == 'ok') {
                            location.reload();
                        } else {
                            setTimeout($.unblockUI, 1);
                            NotificationJG.error(data.mensaje, 'Advertencia!', 10000);
                        }
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        setTimeout($.unblockUI, 1);
                        NotificationJG.error('Error en el servidor', 'Advertencia!', 10000);
                    }).always(function () {
                    });
                } else {
                }
            })
        }

        $(function () {


            $(".tl").tooltip({position: "center up"});

            $("#importar_btn").click(function () {
                {#var onombre = $("#periodo_list").options();#}
                var onombre = document.getElementById('periodo_list').options[document.getElementById('periodo_list').selectedIndex].text;
                var pk = $("#periodo_list").val();
                if (pk != "") {
                    Swal.fire({
                        html: '<b>¿Estás seguro de importar los componentes del periodo: </b>' + onombre + '?',
                        text: "Esta acción es irreversible",
                        type: 'info',
                        showCancelButton: true,
                        showConfirmButton: true,
                        allowOutsideClick: false,
                        buttonsStyling: false,
                        confirmButtonText: 'Si',
                        cancelButtonText: 'No',
                    }).then((result) => {
                        if (result.value) {
                            $.ajax({
                                type: 'POST',
                                url: '{{ reques.path }}',
                                async: false,
                                data: {
                                    csrfmiddlewaretoken: '{{ csrf_token }}',
                                    action: 'importarcomponente',
                                    id: {{ periodo.id }},
                                    idper: pk,
                                },
                                dataType: "json",
                                beforeSend: function () {
                                }
                            }).done(function (data) {
                                {#setTimeout($.unblockUI, 1);#}
                                if (data.result == 'ok') {
                                    NotificationJG.success(data.mensaje, 'Importado!', 10000);
                                    location.reload();
                                } else {
                                    NotificationJG.warning(data.mensaje, 'Advertencia!', 10000);
                                }
                            }).fail(function (jqXHR, textStatus, errorThrown) {
                                setTimeout($.unblockUI, 1);
                                NotificationJG.error('Error en el servidor', 'Advertencia!', 10000);
                            }).always(function () {
                            });
                        }
                    })
                } else {
                    NotificationJG.warning("Seleccione un Periodo", 'Advertencia!', 10000);
                }
            });

            $("select").select2({minimumResultsForSearch: 20});
        });
    </script>
{% endblock %}
{% block atras %}/adm_periodos?action=listadounidades&id={{ periodo.id }}{% endblock %}
{% block canvas %}
    {% if periodo.fin > hoy %}
        <div class='row-fluid'>
            <div class='span12'>
                <h4>{{ title }}</h4>
                {{ periodo }}
            </div>
        </div>
    {% endif %}
    <div class='row-fluid'>
        <div class="span7">
            <a href="/adm_periodos?action=listadolineamientos&id={{ periodo.id }}"
               class='btn btn-default bloqueo_pantalla'><span class="fa fa-list "></span> Lineamientos</a>
        </div>
        <div class="span5" {% if listado %}style="text-align: right; float: left"{% endif %}>
            {% if not listado %}
                <select name="clase" id="periodo_list" style="width: 75%" class="xd">
                    <option value="">Periodo a importar...</option>
                    {% for tc in periodosimportar %}
                        <option value="{{ tc.id }}">{{ tc }}</option>
                    {% endfor %}
                </select>
                <a id="importar_btn" class='btn btn-default'><span
                        class="fa fa-cloud-upload"></span> Importar</a>
            {% else %}
                <a class='btn btn-danger'
                   onclick="eliminarajax2('{{ periodo.id }}', '{{ periodo }}', 'eliminarcomponentes')"><span
                        class="fa fa-trash"></span> Eliminar todo</a>
            {% endif %}
        </div>
    </div>
    <div class='row-fluid'>
        <div class='span12'>
            <table class='table table-striped table-bordered'>
                <thead>
                <tr>
                    <th style="width: 50px;text-align: center">PARCIAL</th>
                    <th style="width: 400px;text-align: justify">COMPONENTE</th>
                    <th style="width: 100px;text-align: center">CANTIDAD</th>
                    <th style="width: 100px;text-align: center">PRÁCTICA</th>
                </tr>
                </thead>
                <tbody>
                {% for lista in listado %}
                    <tr>
                        <td style="text-align: center">{{ lista.parcial }}</td>
                        <td>({{ lista.componente.alias }}) {{ lista.componente }} {% if lista.nivelacion %}

                        <span class="badge badge-info">Nivelación</span>{% endif %}</td>
                        <td style="text-align: center">
                            <input type="text" class="imp-numbersmall" id="id_cantidad{{ lista.id }}"
                                   {% if periodo.fin > hoy %}onchange="calcularubrica({{ lista.id }})"
                                   {% else %}readonly{% endif %} style="font-size: 11px;" value="{{ lista.cantidad }}">
                        </td>
                        <td style="text-align: center">
                            {% if lista.componente.practica %}
                                <i style="color: #468847" class="fa fa-check"></i>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5">SIN REGISTROS</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}
