{% extends "at_activostecnologicos/base_activostecnologicos.html" %}
{% block atras %}{{ request.path }}{% endblock %}
{% load sga_extras %}
{% block extraJs %}
    <script src="/static/adicionalesjs/formquestionb4.js?0.24"></script>
    <link rel="stylesheet" href="/static/css/bloques.css">
    <script>
        $(function () {
            $("select").select2({width: '100%', 'placeholder': 'Seleccione una opción'})
        })

        function formModal(idp, id, text, action, dimension = 'modal-lg', footer = true, idex = '') {
            bloqueointerface()
            $.ajax({
                type: "GET",
                url: `{{ request.path }}`,
                data: {
                    'action': action,
                    'id': id,
                    'idp': idp,
                    'idex': idex,
                },
                success: function (data) {
                    $.unblockUI();
                    footer ? $('#footermodal').hide() : $('#footermodal').show();
                    $('#wmodal').removeClass('modal-lg modal-sm modal-xl modal-md modal-fullscreen').addClass(dimension)
                    if (data.result === true) {
                        $('#itemspanel .panelbody').html(data.data);
                        $('#itemspanel .paneltitle').html(`<i class="fa fa-list-ol"></i> ${text.toUpperCase()}`);
                        $("#itemspanel").modal({backdrop: 'static'}).modal('show');
                    } else {
                        mensajeDanger(data.message);
                    }
                },
                error: function () {
                    $.unblockUI();
                    mensajeDanger("Error de conexión.");
                },
                dataType: "json"
            });
        }
    </script>
    <style>
        .btn-close {
            margin: -8px -3px -0rem auto !important;
        }
    </style>
{% endblock %}
{% block subtitle %}Listado de activos que disponen de informe de baja.{% endblock %}
{% block filtros %}
    <input type="hidden" name="action" value="{{ action }}">

    <div class="mb-1">
        <label for=""><i class="fa fa-traffic-light"></i> Estado:</label>
        <select name="estado">
            <option value="0">Todos</option>
            <option value="1" {% if estado == 1 %}selected{% endif %}>Pendiente</option>
            <option value="2" {% if estado == 2 %}selected{% endif %}>Firmado</option>
        </select>
    </div>
{% endblock %}
{% block content %}
    <div class="row d-flex">
        <div class="col-6">
            <a href="javascript:void(0)"
               onclick="formModal('','','Firmar informes de baja pendientes','firmarinformebajamasivo','modal-md')"
               class='btn btn-success'><i class="fa fa-signature"></i> Firmar informes masivo</a>
        </div>
        <div class='col-6 text-end'>
            <p>
                Total Firmados: <span class="badge bg-success">{{ t_firmados }}</span> |
                Total Pendientes: <span class="badge bg-secondary">{{ t_pendientes }}</span> |
                Total: <span class="badge bg-primary">{{ paging.count }}</span>
            </p>
        </div>
    </div>
    <div class="card mb-4">
        <div class="card-body border-top border-6 rounded-3 border-dark-info">
            <div class="">
                <table class="table table-bordered table-striped tabla_responsive">
                    <thead>
                    <tr class="table-light cabecera-fija">
                        <th class="text-center w-5"><i class="fa fa-sort-numeric-desc"></i></th>
                        <th class="text-center w-30"><i class="fa fa-barcode"></i> Activo</th>
                        <th class="text-center w-30"><i class="fa fa-users"></i> Responsables</th>
                        <th class="text-center w-30"><i class="fa fa-signature"></i> Documento firmado</th>
                        <th class="text-center w-5"><i class="fa fa-cogs"></i></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for list in listado %}
                        <tr>
                            <td class="w-5 text-center align-middle">{{ forloop.counter }}</td>
                            <td class="w-15 align-middle">
                                <div class="row">
                                    <div class="col">
                                        <p class="mb-1">
                                            <b>Modelo: </b>{{ list.informe.activofijo.modelo }}
                                            {% if list.informe.activofijo.statusactivo == 2 %}
                                                | <span class="badge bg-danger" title="Baja">Baja</span>
                                            {% endif %}
                                        </p>
                                        {% if list.informe.activofijo.codigogobierno %}
                                            <p>
                                                <b>Cod. Gobierno: </b>{{ list.informe.activofijo.codigogobierno }}
                                            </p>
                                        {% endif %}
                                        {% if list.codigointerno %}
                                            <p>
                                                <b>Cod. Interno: </b>{{ list.informe.activofijo.codigointerno }}
                                            </p>
                                        {% endif %}
                                    </div>
                                    <div class="col-auto text-center me-2">
                                        <a href="javascript:void(0)"
                                           onclick="formModal('','{{ list.informe.activofijo.id }}','Detalle de activo','detalle_activo','modal-xl',false)"
                                           class="badge-dot bg-primary"
                                           data-bs-toggle="tooltip" data-bs-placement="top" title=""
                                           data-bs-original-title="Detalle de activo">
                                        </a>
                                    </div>
                                </div>
                            </td>
                            <td class="">
                                <p>
                                    <b>Director: </b>{{ list.director.responsable.nombre_completo_minus }}
                                </p>
                                {#                                    <p>#}
                                {#                                        <b>Solicita: </b>{{ list.informe.solicita.nombre_completo_minus }}#}
                                {#                                    </p>#}
                                <p>
                                    <b title="Responsable del informe" data-bs-toggle="tooltip">
                                        Responsable de
                                        informe: </b> {{ list.informe.responsable.nombre_completo_minus }}
                                </p>
                            </td>
                            <td class="text-center">
                                <p><b>Estado: </b>
                                    {% if list.firmadirector %}
                                        <span class="badge bg-success">Firmado</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Pendiente</span>
                                    {% endif %}
                                </p>
                                <p class="mt-2">
                                    <b>Informe: </b><a href="{{ list.archivo.url }}" target="_blank"><i
                                        class="fa fa-file-pdf-o text-danger fs-3"></i></a>
                                </p>
                            </td>
                            <td class="text-center w-5">
                                <div class="dropdown">
                                    <div class="dropdown dropleft">
                                        <a href="javascript:void(0);"
                                           class="btn-icon btn btn-ghost btn-sm rounded-circle"
                                           data-bs-toggle="dropdown" data-offset="-140" aria-haspopup="true"
                                           aria-expanded="false">
                                            <i class="fa fa-ellipsis-v" aria-hidden="true"></i>
                                        </a>
                                        <ul class="dropdown-menu">
                                            {% if perms.sagest.puede_gestionar_informeactivo_tecnologico %}
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item"
                                                       onclick="formModalReport('{{ list.id|encrypt }}','Firmar informe de baja de {{ listado.informe_baja.solicita.nombre_completo_minus }}','firmarinformebaja','firmadirector')">
                                                        <i class="fa fa-signature dropdown-item-icon"></i> Firmar
                                                        informe baja
                                                    </a>
                                                </li>
                                            {% endif %}
                                            {% if persona.id == list.informe.responsable.id %}
                                                <li>
                                                    <a href="javascript:void(0)"
                                                       class="dropdown-item"
                                                       onclick="eliminarajax('{{ list.id|encrypt }}','Eliminar acta de constatación','delacta')">
                                                        <i class="fa fa-trash-o dropdown-item-icon"></i> Eliminar informe baja
                                                    </a>
                                                </li>
                                            {% endif %}
                                            <li>
                                                <a href="javascript:void(0)"
                                                   class="dropdown-item"
                                                   onclick="formModal('','{{ list.id|encrypt }}','Historial de firmas de informe','historialfirmas','modal-lg',false)">
                                                    <i class="fa fa-clock-o dropdown-item-icon"></i> Historial de firmas
                                                </a>
                                            </li>
                                        </ul>

                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            {% empty %}
                            <td colspan="8" style="text-align: center">NO TIENE ACTIVOS</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <div class="card-footer border-top-0">
                    {% include 'paginacionb4.html' %}
                </div>

            </div>
        </div>
    </div>
{% endblock %}
{% block moreblock %}
    <div class="modal fade static" id="itemspanel" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document" id="wmodal">
            <div class="modal-content" style="border-radius: 17px!important;">
                <div class="modal-header">
                    <h4><b class="paneltitle">FORMULARIO MODAL</b></h4>
                    <button type="button" class="btn-close btn-cerrar-modal fs-5" data-toggle="modal"
                            data-bs-dismiss="modal" aria-label="Close">
                        X
                    </button>
                </div>
                <div class="modal-body" style="padding: 1.5%;">
                    <form class="form-horizontal form-modal" autocomplete="off" method="post"
                          enctype="multipart/form-data" action="{{ request.path }}">
                        {% csrf_token %}
                        <div class="row panelbody">
                        </div>
                    </form>
                </div>
                <div class="modal-footer" id="footermodal">
                    <button type="button" class="btn btn-default" data-bs-dismiss="modal" id="cerrar"><i
                            class="fa fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}