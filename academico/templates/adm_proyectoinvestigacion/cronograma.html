{% extends "ajaxformbs.html" %}
{% load sga_extras %}
{% block extraheading %}

    <style type="text/css">
        .hiddenRow {
            padding: 0 !important;
        }
    </style>
    <script type="text/javascript">
        $(function(){
            $("select").select2({minimumResultsForSearch: 20 });

            $("#id_ponderaciontotal").addClass("validate[required, min[1], max[100]]");

            contador_persona = 0;
            filaagregapersona = "";
            abreviaturafila = "";

            lista_responsables = [];

            {% for objetivo in objetivos %}
                var nf_{{ objetivo.id }} = 0;
            {% endfor %}

            {% for objetivo in objetivos %}
                valoresPonderacion_{{ objetivo.id }} = function (){
                    numerico($(this), 0.01, 100, 2);
                    sumarponderaciones_{{ objetivo.id }}();
                };

            {% endfor %}

            {% for objetivo in objetivos %}
                sumarponderaciones_{{ objetivo.id }} = function (){
                    var aponderaciones = new Array();

                    var acantidades = new Array();
                    var aincluyeiva = new Array();
                    var avaloriva = new Array();
                    var atotal = new Array();

                    $('input[name="valorponderacion_{{ objetivo.id }}[]"]').each(function () {
                        valor_{{ objetivo.id }} = parseFloat($(this).val());
                        aponderaciones.push(parseFloat($(this).val()));
                    });


                    var suma = 0;
                    for (i = 0; i < aponderaciones.length; i++) {
                        var total = 0;
                        total = aponderaciones[i];
                        suma += total;
                    }


                    $("#lbl_totalponderacion_{{ objetivo.id }}").html("" + suma.toFixed(2));
                    $("#lbl_totalobjetivo_{{ objetivo.id }}").html("" + suma.toFixed(2));
                    $("#bdg_totalactividades_{{ objetivo.id }}").html(aponderaciones.length);

                    calculartotalponderacion();
                };
            {% endfor %}

            calculartotalponderacion = function (){
                var totalponderacion = 0;
                {% for objetivo in objetivos %}
                    $('input[name="valorponderacion_{{ objetivo.id }}[]"]').each(function () {
                        totalponderacion += parseFloat($(this).val());
                    });
                {% endfor %}
                $("#id_ponderaciontotal").val(totalponderacion.toFixed(2));
            };


            {% for objetivo in objetivos %}
                $(".agregaitem_{{ objetivo.id }}").click(function() {
                    if(datos_{{ objetivo.id }}_completo()) {
                        nf_{{ objetivo.id }} += 1;

                        nueva = '<tr id="fila_{{ objetivo.id }}_' + nf_{{ objetivo.id }}.toString() + '">' +
                            '<td> <input type="hidden" id="idactividad_{{ objetivo.id }}[]" name="idactividad_{{ objetivo.id }}[]" value="0"> <input autocomplete="off" style="text-align: left; width: 100%; text-transform: none" maxlength="5000" id="actividad_{{ objetivo.id }}[]" name="actividad_{{ objetivo.id }}[]" type="text" value="" ></td>' +
                            '<td><input autocomplete="off" style="text-align: right; width: 100%; text-transform: none" maxlength="6" id="valorponderacion_{{ objetivo.id }}[]" name="valorponderacion_{{ objetivo.id }}[]" type="text" value="0.00" class="valoresponderacion_{{ objetivo.id }}"></td>' +
                            '<td style="text-align: center"><input type="text" class="selectorfecha" id="fechainicio_{{ objetivo.id }}[]" name="fechainicio_{{ objetivo.id }}[]" value="" readonly style="cursor:text; background-color: #FFFFFF"/></td>' +
                            '<td style="text-align: center"><input type="text" class="selectorfecha" id="fechafin_{{ objetivo.id }}[]" name="fechafin_{{ objetivo.id }}[]" value="" readonly style="cursor:text; background-color: #FFFFFF"/></td>' +
                            '<td><input autocomplete="off" style="text-align: left; width: 100%; text-transform: none" maxlength="5000" id="entregable_{{ objetivo.id }}[]" name="entregable_{{ objetivo.id }}[]" type="text" value="" ></td>' +
                            '<td id="td_{{ objetivo.id }}_'+ nf_{{ objetivo.id }}.toString() +'_6"  >    <a href="javascript:;" class="btn btn-tini btn-success agregarpersona_{{ objetivo.id }} tu" abrev="{{ objetivo.id }}"  idf="' + nf_{{ objetivo.id }}.toString() + '" title="Agregar responsable"><i class="fa fa-user-plus"></i></a>  <input style="text-align: right; width: 100%; text-transform: none; background-color: white" maxlength="5000" id="codigosresponsables_{{ objetivo.id }}_'+ nf_{{ objetivo.id }}.toString()+'" name="codigosresponsables_{{ objetivo.id }}[]" type="hidden" value="" readonly="readonly" >   '+
                            '</td>'+
                            '<td><a href="javascript:;" class="btn btn-tini btn-danger eliminaritem_{{ objetivo.id }} tu" idf="' + nf_{{ objetivo.id }}.toString() + '" title="Eliminar actividad"><i class="fa fa-remove"></i></a></td>';

                        $("#detalle_cronograma_{{ objetivo.id }}").append(nueva);
                        $("#detalle_cronograma_{{ objetivo.id }}").find(".selectorfecha").datepicker({format:"yyyy-mm-dd"}).on('changeDate', function(ev){ $(this).datepicker('hide'); });
                        $(".agregarpersona_{{ objetivo.id }}").unbind("click.agregarPersona_{{ objetivo.id }}");
                        $(".agregarpersona_{{ objetivo.id }}").bind("click.agregarPersona_{{ objetivo.id }}", agregarPersona_{{ objetivo.id }});
                        $(".eliminaritem_{{ objetivo.id }}").unbind("click.eliminarItem_{{ objetivo.id }}");
                        $(".eliminaritem_{{ objetivo.id }}").bind("click.eliminarItem_{{ objetivo.id }}", eliminarItem_{{ objetivo.id }});
                        $(".valoresponderacion_{{ objetivo.id }}").unbind("blur.valoresPonderacion_{{ objetivo.id }}");
                        $(".valoresponderacion_{{ objetivo.id }}").bind("blur.valoresPonderacion_{{ objetivo.id }}", valoresPonderacion_{{ objetivo.id }});

                    }
                });
            {% endfor %}

            {% for objetivo in objetivos %}
                datos_{{ objetivo.id }}_completo = function (){
                    var c1e = true, c2e = true, c3e = true, c4e = true, c5e = true, c6e = true, c7e = true;

                    $('input[name="actividad_{{ objetivo.id }}[]"]').each(function() {
                        if($(this).val().trim()==''){
                            c1e = false;
                            return false;
                        }
                    });

                    $('input[name="valorponderacion_{{ objetivo.id }}[]"]').each(function() {
                        if($(this).val().trim()==''){
                            c2e = false;
                            return false;
                        }
                    });

                    $('input[name="fechainicio_{{ objetivo.id }}[]"]').each(function() {
                        if($(this).val().trim()==''){
                            c3e = false;
                            return false;
                        }
                    });

                    $('input[name="fechafin_{{ objetivo.id }}[]"]').each(function() {
                        if($(this).val().trim()==''){
                            c4e = false;
                            return false;
                        }
                    });

                    /*$('input[name="descripcion_{{ tiporecurso.abreviatura }}[]"]').each(function() {
                        if($(this).val().trim()==''){
                            c2e = false;
                            return false;
                        }
                    });

                    $('select[name="unidadmedida_{{ tiporecurso.abreviatura }}[]"]').each(function() {
                        valor = parseInt($(this).val());
                        if(valor == 0){
                            c3e = false;
                            return false;
                        }
                    });

                    $('input[name="cantidad_{{ tiporecurso.abreviatura }}[]"]').each(function() {
                        if($(this).val().trim()==''){
                            c4e = false;
                            return false;
                        }
                    });

                    $('input[name="valorunitario_{{ tiporecurso.abreviatura }}[]"]').each(function() {
                        if($(this).val().trim()==''){
                            c5e = false;
                            return false;
                        }
                    });


                    if(parseFloat($("#id_ponderaciontotal").val()) > parseFloat($("#id_montototal").val())){
                        smoke.alert("El total presupuestado no debe exceder a " + $("#id_montototal").val());
                        c7e = false;
                        return false;
                    }*/

                    return (c1e && c2e && c3e && c4e && c5e && c6e && c7e);
                };
            {% endfor %}

            {% for objetivo in objetivos %}
                eliminarItem_{{ objetivo.id }} = function() {
                    var id = $(this).attr("idf");
                    $("#fila_{{ objetivo.id }}_"+id).remove();
                    sumarponderaciones_{{ objetivo.id }}();
                };
            {% endfor %}

            {% for objetivo in objetivos %}
                agregarPersona_{{ objetivo.id }} = function() {
                    var idp='{{ id }}';

                    $("#itemspanelparticipante").modal({backdrop:'static', width: '700px'}).modal('show');

                    var id = $(this).attr("idf");
                    var abrev = $(this).attr('abrev');
                    filaagregapersona = id;
                    abreviaturafila = abrev;
                };
            {% endfor %}

            {% for objetivo in objetivos %}
                actualizarlistaPersona_{{ objetivo.id }} = function(idfila) {
                    var id = idfila;
                    var codigosPersonas_{{ objetivo.id }}="";

                    $("#td_{{ objetivo.id }}_"+id+"_6 .grupopersona").each(function() {
                        codigosPersonas_{{ objetivo.id }} += $(this).attr('idpersona')+",";
                    });

                    $("#codigosresponsables_{{ objetivo.id }}_"+id).val(codigosPersonas_{{ objetivo.id }});
                };
            {% endfor %}

            {% for objetivo in objetivos %}
                borrarPersona_{{ objetivo.id }} = function() {
                    var id = $(this).attr("idpersona");
                    var idf = $(this).attr("idf");

                    $("#persona"+id).remove();

                    actualizarlistaPersona_{{ objetivo.id }}(idf);
                };
            {% endfor %}

            $("#itemspanelparticipante .agregar").click(function () {
                var idpe = $("#personalproyecto").val();

                var i = 0;
                var nombrepersona;

                if($('select[name=personalproyecto] option:selected').size() == 0){
                    smoke.alert("Seleccione el(los) responsable(s) para la actividad");
                }else {
                    var codigos_personas =  $("#personalproyecto").val();
                    var nombres_personas = $('#personalproyecto option:selected').toArray().map(item => item.text);
                    var listaper=$("#codigosresponsables_"+abreviaturafila+"_"+filaagregapersona).val();

                    for(i=0; i < codigos_personas.length; i++){
                        if(listaper.search(codigos_personas[i]) >=0){
                            smoke.alert("La persona "+nombres_personas[i]+" ya ha sido asignada a la actividad");
                            return false;
                        }
                    }

                    for(i=0; i < codigos_personas.length; i++){
                        idpe = codigos_personas[i];
                        nombrepersona = nombres_personas[i];

                        contador_persona++;

                        var objeto = "<span class='grupopersona' idpersona='" + idpe + "' id='persona" + contador_persona.toString() + "'><span class='label label-info'>" + nombrepersona + "</span>" +
                            "<a href='javascript:;' idf='" + filaagregapersona + "'  idpersona='" + contador_persona.toString() + "' class='borrarpersona_" + abreviaturafila + " btn-danger btn-tini' title='Borrar responsable'><i class='fa fa-user-times'></i></a></span>"

                        $("#td_" + abreviaturafila + "_" + filaagregapersona + "_6").append(objeto);
                        $(".borrarpersona_" + abreviaturafila).unbind("click.borrarPersona_" + abreviaturafila);
                        $(".borrarpersona_" + abreviaturafila).bind("click.borrarPersona_" + abreviaturafila, eval("borrarPersona_" + abreviaturafila));

                    }
                    $("#personalproyecto").val("0").trigger('change');
                    eval("actualizarlistaPersona_" + abreviaturafila + "(" + filaagregapersona + ");");
                    $('#itemspanelparticipante').modal('hide');
                }
                return false;
            });

            $("#itemspanelparticipante .cerrar").click(function () {
                $('#itemspanelparticipante').modal('hide');
            });

            $("#itemspanelparticipante .cerrar2").click(function () {
                $('#itemspanelparticipante').modal('hide');
            });

            {% for detalle in detallecronograma %}
                nf_{{ detalle.objetivo.id }} += 1;

                var listaresp = "";

                {% for p in detalle.lista_responsables %}
                    contador_persona ++;
                    listaresp += "{{ p.persona.id }},";
                    idpe = "{{ p.persona.id }}";
                    nombrepersona = "{{ p.persona }}";

                    datopersona = {idobjetivo: {{ detalle.objetivo.id }},
                                   filaobjetivo: nf_{{ detalle.objetivo.id }},
                                   contadorpersona: contador_persona,
                                   idpersona: idpe,
                                   nombrepersona: nombrepersona};
                    lista_responsables.push(datopersona);

                {% endfor %}


                nueva = '<tr id="fila_{{ detalle.objetivo.id }}_' + nf_{{ detalle.objetivo.id }}.toString() + '">' +
                            '<td> <input type="hidden" id="idactividad_{{ detalle.objetivo.id }}[]" name="idactividad_{{ detalle.objetivo.id }}[]" value="{{ detalle.id }}">  <input autocomplete="off" style="text-align: left; width: 100%; text-transform: none" maxlength="5000" id="actividad_{{ detalle.objetivo.id }}[]" name="actividad_{{ detalle.objetivo.id }}[]" type="text" value="{{ detalle.actividad }}" ></td>' +
                            '<td><input autocomplete="off" style="text-align: right; width: 100%; text-transform: none" maxlength="6" id="valorponderacion_{{ detalle.objetivo.id }}[]" name="valorponderacion_{{ detalle.objetivo.id }}[]" type="text" value="{{ detalle.ponderacion }}" class="valoresponderacion_{{ detalle.objetivo.id }}"></td>' +
                            '<td style="text-align: center"><input type="text" class="selectorfecha" id="fechainicio_{{ detalle.objetivo.id }}[]" name="fechainicio_{{ detalle.objetivo.id }}[]" value="{{ detalle.fechainicio|date:'Y-m-d' }}" readonly style="cursor:text; background-color: #FFFFFF"/></td>' +
                            '<td style="text-align: center"><input type="text" class="selectorfecha" id="fechafin_{{ detalle.objetivo.id }}[]" name="fechafin_{{ detalle.objetivo.id }}[]" value="{{ detalle.fechafin|date:'Y-m-d' }}" readonly style="cursor:text; background-color: #FFFFFF"/></td>' +
                            '<td><input autocomplete="off" style="text-align: left; width: 100%; text-transform: none" maxlength="5000" id="entregable_{{ detalle.objetivo.id }}[]" name="entregable_{{ detalle.objetivo.id }}[]" type="text" value="{{ detalle.entregable }}" ></td>' +
                            '<td id="td_{{ detalle.objetivo.id }}_'+ nf_{{ detalle.objetivo.id }}.toString() +'_6"  >    <a href="javascript:;" class="btn btn-tini btn-success agregarpersona_{{ detalle.objetivo.id }} tu" abrev="{{ detalle.objetivo.id }}"  idf="' + nf_{{ detalle.objetivo.id }}.toString() + '" title="Agregar responsable"><i class="fa fa-user-plus"></i></a>  <input style="text-align: right; width: 100%; text-transform: none; background-color: white" maxlength="5000" id="codigosresponsables_{{ detalle.objetivo.id }}_'+ nf_{{ detalle.objetivo.id }}.toString()+'" name="codigosresponsables_{{ detalle.objetivo.id }}[]" type="hidden" value="'+listaresp+'" readonly="readonly" >   '+
                            '</td>'+
                            '<td><a href="javascript:;" class="btn btn-tini btn-danger eliminaritem_{{ detalle.objetivo.id }} tu" idf="' + nf_{{ detalle.objetivo.id }}.toString() + '" title="Eliminar actividad"><i class="fa fa-remove"></i></a></td>';

                $("#detalle_cronograma_{{ detalle.objetivo.id }}").append(nueva);
                $("#detalle_cronograma_{{ detalle.objetivo.id }}").find(".selectorfecha").datepicker({format:"yyyy-mm-dd"}).on('changeDate', function(ev){ $(this).datepicker('hide'); });
                $(".agregarpersona_{{ detalle.objetivo.id }}").unbind("click.agregarPersona_{{ detalle.objetivo.id }}");
                $(".agregarpersona_{{ detalle.objetivo.id }}").bind("click.agregarPersona_{{ detalle.objetivo.id }}", agregarPersona_{{ detalle.objetivo.id }});
                $(".eliminaritem_{{ detalle.objetivo.id }}").unbind("click.eliminarItem_{{ detalle.objetivo.id }}");
                $(".eliminaritem_{{ detalle.objetivo.id }}").bind("click.eliminarItem_{{ detalle.objetivo.id }}", eliminarItem_{{ detalle.objetivo.id }});
                $(".valoresponderacion_{{ detalle.objetivo.id }}").unbind("blur.valoresPonderacion_{{ detalle.objetivo.id }}");
                $(".valoresponderacion_{{ detalle.objetivo.id }}").bind("blur.valoresPonderacion_{{ detalle.objetivo.id }}", valoresPonderacion_{{ detalle.objetivo.id }});


            {% endfor %}

            {% for objetivo in objetivos %}
                sumarponderaciones_{{ objetivo.id }}();
            {% endfor %}

            for(ind in lista_responsables){

                var objeto = "<span class='grupopersona' idpersona='" + lista_responsables[ind].idpersona + "' id='persona" + lista_responsables[ind].contadorpersona + "'><span class='label label-info'>" + lista_responsables[ind].nombrepersona + "</span>" +
                             "<a href='javascript:;' idf='" + lista_responsables[ind].filaobjetivo + "'  idpersona='" + lista_responsables[ind].contadorpersona + "' class='borrarpersona_" + lista_responsables[ind].idobjetivo + " btn-danger btn-tini' title='Borrar responsable'><i class='fa fa-user-times'></i></a></span>"

                $("#td_" + lista_responsables[ind].idobjetivo + "_" + lista_responsables[ind].filaobjetivo + "_6").append(objeto);
                $(".borrarpersona_" + lista_responsables[ind].idobjetivo).unbind("click.borrarPersona_" + lista_responsables[ind].idobjetivo);
                $(".borrarpersona_" + lista_responsables[ind].idobjetivo).bind("click.borrarPersona_" + lista_responsables[ind].idobjetivo, eval("borrarPersona_" + lista_responsables[ind].idobjetivo));
            }

{#            {% if estadoproyecto != 1 and estadoproyecto != 4 %}#}
{#                $("#formbutton").hide();#}
{#            {% endif %}#}
            $("#formbutton").hide();
            $("#formcancel").removeClass("btn btn-danger").addClass("btn btn-info");

        });
    </script>
{% endblock %}

{% block cancelname %}Aceptar{% endblock %}
{% block atras %}/adm_proyectoinvestigacion{% endblock %}
{% block titulo %}{{ title }}{% endblock %}
{% block formaction %}/adm_proyectoinvestigacion{% endblock %}
{% block formwidth %}form-xxl{%  endblock %}
{% block formdestination %}/adm_proyectoinvestigacion{% endblock %}

{% block mensajes_form %}
    <div class="row-fluid">
        <div class='span12'>
            <a href="/adm_proyectoinvestigacion?action=datosprincipales&id={{ id }}" class='btn btn-default tu' title="Datos Generales"><span class="fa fa-id-card" ></span> Datos Generales</a>
            <a href="/adm_proyectoinvestigacion?action=personalproyecto&id={{ id }}" class='btn btn-default tu' title="Integrantes"><span class="fa fa-users" ></span> Integrantes</a>
            <a href="/adm_proyectoinvestigacion?action=contenidoproyecto&id={{ id }}" class='btn btn-default tu' title="Contenido"><span class="fa fa-list" ></span> Contenido</a>
            <a href="/adm_proyectoinvestigacion?action=presupuestoproyecto&id={{ id }}" class='btn btn-default tu' title="Presupuesto"><span class="fa fa-money" ></span> Presupuesto</a>
            <a href="javascript:;" class='btn btn-success tu' title="Cronograma"><span class="fa fa-tasks" ></span> Cronograma</a>
        </div>
    </div>
{% endblock %}

{% block formextra %}
    <input type='hidden' name='action' value='editcronograma'/>
    <input type='hidden' name='id' value='{{ id }}'/>
{% endblock %}

{% block formback %}/adm_proyectoinvestigacion{% endblock %}

{#{% block buttonname %}Guardar{% endblock %}#}
{% block formsuffix %}
    <div class="row-fluid" id="detallecronograma">
        <div style="width: 100%; height: max-content; display: inline-block">
            <h6 style="width:100%; text-align:left; border-bottom: 1px solid #98a3ab; line-height:0.1em; margin:10px 0 20px;"><span style="padding:0 10px; background: #f5f5f5;">Cronograma de Actividades del Proyecto</span></h6>
        </div>
        <div class="accordion" id="accordion2">
        {% for objetivo in objetivos %}
            <div class="accordion-group">
                <div class="accordion-heading" style="background-color: whitesmoke">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapse_{{ objetivo.id }}">
                        {{ objetivo.descripcion }}
                        <span class="badge badge-info tu" title="Total Actividades" id="bdg_totalactividades_{{ objetivo.id }}">0</span>
                        <span class="label label-success tu" title="Total % ponderación" id="lbl_totalobjetivo_{{ objetivo.id }}">0.00</span>
                    </a>
                </div>
                <div id="collapse_{{ objetivo.id }}" class="accordion-body collapse in">
                    <div class="accordion-inner" style="padding: 5px">
                        <table class="table table-bordered" id="tbrecurso_{{ objetivo.id }}">
                            <thead>
                                <tr>
                                    <th width="40%" style="text-align: center">Actividad</th>
                                    <th width="10%" style="text-align: center">Ponderación (%)</th>
                                    <th width="8%" style="text-align: center">Fecha Inicio</th>
                                    <th width="8%" style="text-align: center">Fecha Fin</th>
                                    <th width="15%" style="text-align: center">Entregable</th>
                                    <th width="40%" style="text-align: center">Responsables</th>
                                    <th width="2%"><a href="javascript:;" class="btn btn-success btn-mini agregaitem_{{ objetivo.id }}" title="Agregar actividad"><i class="fa fa-plus"></i> </a></th>
                                </tr>
                            </thead>
                            <tbody id="detalle_cronograma_{{ objetivo.id }}">

                            </tbody>
                            <tfoot>
                                <td colspan="1"><strong>TOTAL PONDERACIÓN</strong></td>
                                <td style="text-align: right"><strong><span id="lbl_totalponderacion_{{ objetivo.id }}">0.00</span></strong></td>
                                <td colspan="5"></td>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        {% endfor %}
        </div>
    </div>

    <div class="modal fade static"  data-keyboard="false" id="itemspanelparticipante" style="display: none;">
        <div class="modal-header">
            <table border="0" width="100%" style="background-color: transparent">
                <tr>
                    <td style="width: 80%"><h4 class="paneltitleparticipante">Agregar Responsable</h4></td>
                    <td><a href="javascript:;" title="Cerrar" class="btn btn-danger btn-mini pull-right cerrar2"><i class="fa fa-remove"></i></a></td>
                </tr>
            </table>
        </div>
        <div class="modal-body panelbodyparticipante">
{#            <form id="formularioparticipante" style="width: 100%; margin-bottom: 0px;padding-left: 0px;padding-top: 0px; padding-right: 0px; padding-bottom: 0px">#}
                <table class="table table-bordered" >
                    <tbody>
                        <tr>
                            <td style="width: 15%">Persona Responsable:</td>
                            <td>
                                <select id="personalproyecto" multiple name="personalproyecto" style="width: 95%">
{#                                    <option value="" selected>---------</option>#}
                                    {% for personal in personalproyecto %}
                                        <option value="{{ personal.persona.id }}">{{ personal.persona }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
{#            </form>#}
        </div>
        <div class="modal-footer" style="text-align: right">
            <a href="javascript:;" class="btn btn-success agregar"> Agregar</a>
            <a href="javascript:;" class="btn btn-danger cerrar"> Cancelar</a>
        </div>
    </div>

{% endblock %}