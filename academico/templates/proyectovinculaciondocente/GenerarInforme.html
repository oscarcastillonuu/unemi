{% extends "base.html" %}
{% load sga_extras %}
{% block heading %}
{#    <script src="/static/adicionalesjs/formquestionb4.js?0.24"></script>#}
    <style>
        th {
            position: sticky;
            top: 30px;
            z-index: 10;
            background-color: #ffffff;
        }

        tbody td, th {
            border-right: 1px solid #CCC;
        }

    </style>

    <script>
        function aprobarajax(pk, nombre, accion) {
            Swal.fire({
                title: `Estas seguro de solicitar la revisión de este informe\n ${nombre}`,
                text: "Esta acción es irreversible",
                type: 'warning',
                showCancelButton: true,
                allowOutsideClick: false,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Si, deseo hacerlo',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.value) {
                    bloqueointerface();
                    $("#itemspanel").modal('hide');

                    $.get('/proyectovinculaciondocente', {'action': 'generarinformepdf', 'id': '{{ configuracion.pk }}', 'json': true}, function (backend) {
                        if (backend.result == 'ok') {
                            if (backend.data) {
                                $('#itemspanel .modal-footer').hide();
                                $('#itemspanel .panelbody').html(backend.data);
                                $('#itemspanel .paneltitle').html('Firmar documento');
                                $("#itemspanel").modal({backdrop: 'static', width: '90%'}).modal('show').on('hidden.bs.modal', function (e) {
                                    $('#itemspanel .panelbody').empty();
                                    $('#itemspanel .modal-footer').show();
                                });

                                $.unblockUI();
                            }
                        } else {
                            $.unblockUI();
                            alertaDanger(backend.mensaje, 10000);
                        }
                    });


                } else {
                    NotificationJG.error('Acción Anulada', 'Advertencia!', 10000);
                    $.unblockUI()
                }
            })
        }
    </script>

{% endblock %}
{% block atras %}/proyectovinculaciondocente?action=configurarinforme&id={{ proyecto.pk }}{% endblock %}

{% block canvas %}
    <div class="row">
        <div class="col-sm-12">
            <a href="javascript:;" class="btn btn-success aprobacionSolicitud py-2" onclick="aprobarajax('{{ configuracion.id }}',  '{{ configuracion.fecha_inicio|date:'d-m-Y'}} / {{ configuracion.fecha_fin|date:'d-m-Y' }}',  'solicitudrevision')" data-toggle="tooltip" data-placement="top" title="Solicitar Revisión"> <i class="fa fa-check"></i> Solicitar revisión</a>
        </div>
    </div>

    <div class="row">
        <div class="card">
            <div class="card-body border-top border-6 rounded-3 border-dark-info table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>N.</th>
                            <th>Actividades</th>
                            <th>Indicadores Verificables</th>
                            <th>Medios de Verificación (evidencias anexadas)</th>
                            <th>Factores de problemas</th>
                            <th>Factores de éxito</th>
                            <th>Estado</th>
                            <th>Alcance</th>
                            <th>Avance AC.</th>
                            <th>Avance M.</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr bgcolor="#f0f0f0">
                            <td colspan="11">
                                <br><b>FIN</b>
                            </td>
                        </tr>
                        {% for fin in  fines %}
                            <tr name="item">
                                <td>{{ fin.actividad.arbolObjetivo.orden }}</td>
                                <td>{{ fin.actividad.arbolObjetivo.detalle }}</td>
                                <td>{{ fin.indicador }}</td>
                                <td>{{ fin.fuente }}</td>
                                <td>{{ fin.factor_problema }}</td>
                                <td>{{ fin.factor_exito }}</td>
                                <td>{% if fin.editado %}
                                    <span class="badge bg-success">EDITADO</span>
                                {% else %}
                                    <span class="badge bg-warning">SIN EDITAR</span>
                                {% endif %}</td>
                                <td> - </td>
                                <td><span class="badge bg-success">{{ fin.porcentaje_avance }}%</span></td>
                                <td>-</td>
                                <td>
                                    <a href='/proyectovinculaciondocente?action=editgenerar&id={{ fin.pk }}' class="btn btn-warning"><span class="fa fa-edit"></span> </a>
                                </td>
                            </tr>
                        {% endfor %}

                        <tr bgcolor="#f0f0f0 ">
                            <td colspan="11">
                                <b>PROPÓSITOS</b> <br>
                            </td>
                        </tr>

                        {% for pro in  propositos %}
                            <tr >
                                <td>{{ pro.actividad.arbolObjetivo.orden }}</td>
                                <td>{{ pro.actividad.arbolObjetivo.detalle }}</td>
                                <td>{{ pro.indicador }}</td>
                                <td>{{ pro.fuente }}</td>
                                <td>{{ pro.factor_problema }}</td>
                                <td>{{ pro.factor_exito }}</td>
                                <td>{% if pro.editado %}
                                    <span class="badge bg-success">EDITADO</span>
                                {% else %}
                                    <span class="badge bg-warning">SIN EDITAR</span>
                                {% endif %}
                                </td>
                                <td><span class="badge bg-success">100%</span></td>
                                <td><span class="badge bg-success">{{ pro.porcentaje_avance }}%</span></td>
                                <td><span class="badge bg-warning"><b>{{ configuracion.avance_registro|floatformat:4 }} %</b></span></td>
                                <td>
                                    <a href='/proyectovinculaciondocente?action=editgenerar&id={{ pro.pk }}' class="btn btn-warning"><span class="fa fa-edit"></span> </a>
                                </td>
                            </tr>
                        {% endfor %}

                        {% for too in aPro_marcoLogico_componentes %}
                            <tr bgcolor="#f0f0f0 ">
                                <td colspan="7">
                                    <b>COMPONENTE</b> <br>
                                    {{ too.arbolObjetivo.orden }} {{ too.arbolObjetivo.detalle }}
                                </td>
                                <td align="right">
                                    <span class="badge bg-success"> {{ too.cumplimiento|floatformat:4 }}% </span>
                                </td>
                                <td align="right">
                                    <span class="badge bg-warning"> {{ too.avance|floatformat:4 }}% </span>
                                </td>
                                <td>
                                    <span class="badge bg-warning"> {{ too.avancemensual|floatformat:4 }}% </span>
                                </td>
                            <td></td>

                            </tr>
                            {% for foo in aPro_marcoLogico_acciones %}
                                {% if too.arbolObjetivo.pk  == foo.arbolObjetivo.parentID.pk %}
                                    <tr bgcolor="#f0f0f0 ">
                                        <td colspan="7">
                                            <b>ACCIÓN / ACTIVIDAD</b> <br>
                                            {{ foo.arbolObjetivo.orden }} {{ foo.arbolObjetivo.detalle }}
                                        </td>
                                        <td align="right">
                                            <span class="badge bg-success"> {{ foo.cumplimiento|floatformat:4 }}% </span>
                                        </td>
                                        <td align="right">
                                            <span class="badge bg-warning"> {{ foo.avance|floatformat:4 }}% </span>
                                        </td>
                                        <td><span class="badge bg-warning"> {{ foo.avancemensual|floatformat:4 }}% </span></td>
                                        <td></td>
                                    </tr>
                                    {% for list in acciones %}
                                        {% if list.tarea.aobjetivo.pk == foo.arbolObjetivo.pk %}
                                            <tr name="item">
                                                <td>{{ list.actividad.arbolObjetivo.orden }}</td>
                                                <td>{{ list.tarea.descripcion }}</td>
                                                <td>{{ list.indicador }}</td>
                                                <td>{{ list.fuente }}</td>
                                                <td>{{ list.factor_problema }}</td>
                                                <td>{{ list.factor_exito }}</td>
                                                <td>{% if list.editado %}
                                                    <span class="badge bg-success">EDITADO</span>
                                                {% else %}
                                                    <span class="badge bg-warning">SIN EDITAR</span>
                                                {% endif %}</td>

                                                <td><span class="badge bg-success">{{ list.tarea.cumplimiento|floatformat:4 }}%</span></td>
                                                <td><span class="badge bg-warning">{{ list.avanceacumulado|floatformat:4 }}%</span></td>
                                                <td><span class="badge bg-warning">{{ list.porcentaje_avance|floatformat:4 }}%</span></td>
                                                <td>
                                                    <a href='/proyectovinculaciondocente?action=editgenerar&id={{ list.pk }}' class="btn btn-warning"><span class="fa fa-edit"></span> </a>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        <tr>
                            <td colspan="9">Total Avance Meses Anteriores</td>
                            <td align="center">
                                <span class="badge bg-success"><b>{{ configuracion.avancesmesanterior|floatformat:4}}%</b></span>
                            </td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="9">Total del Mes Reportado</td>
                            <td align="center">
                                <span class="badge bg-success"><b>{{ configuracion.avance_registro|floatformat:4 }} %</b></span>
                            </td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="9">Total de horas asignadas</td>
                            <td align="center">
                                <span class="badge bg-success"><b>{{ configuracion.profesor.total_horas_vinculacion}}</b></span>
                            </td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade static" id="itemspanel" style="display: none;">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-md">
            <div class="modal-content px-2">
                <div class="modal-header border-0 mt-1">
                    <div class="headtitle mt-3 ms-0"><h4 class="ps-1 py-0 paneltitle"></h4></div>
                    <button type="button" class="btn btn-close btn-cian-secondary rounded-circle p-3 my-0" style="padding:10px!important;" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formulariomodal" class="form-horizontal form-modal" autocomplete="off" method="post" enctype="multipart/form-data" action="{{ request.path }}">
                        {% csrf_token %}
                        <div class="row panelbody"></div>
                    </form>
                </div>
                <div class="modal-footer border-0 pe-2">
                    <a href="javascript:;" class="btn btn-aprobarcerrar btn-success py-2 me-1"><i class="fa fa-save"></i> Guardar</a>
                    <a href="javascript:;" class="btn btn-danger py-2" data-bs-dismiss="modal"><i class="fa fa-times"></i> Cerrar</a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
